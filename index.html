<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    .hijauku {
        color: #16c784;
        font-size: 15px;
    }

    .merahku {
        color: #ea3943;
        font-size: 15px;
    }

    .singkatanku {
        color: #c7c0c0;
        font-size: 18px;
    }

    .divku-1 {
        text-align: center;
        padding: 10px 10px 0px 10px;
    }

    .card-col {
        margin-bottom: 20px;
    }
</style>

<body>
    <div class="container text-center">
        <h1>Cry-Market</h1>
    </div>
    <div class="container">
        <div class="row" id="coin-container">

        </div>
    </div>
    <script src="./dist/main.js"></script>
    <script>
        $(document).ready(function () {
            console.log("ready!");
            let today;


            // let date1 = new Date();
            // today = date1.toISOString();
            // alert(date1.toISOString());

            // let yesterday;
            // var date2 = new Date();
            // date2.setDate(date2.getDate() - 1);
            // alert(date2.toISOString());

            getAllItem();
        });

        const myKey = '5147C05F-48E2-4E36-9777-EE8636661C6F';
        const baseUrl = 'https://rest.coinapi.io/v1';
        const filterCoin = '?filter_asset_id=BTC;ADA;MATIC;SOL;XRP;ETH;DOGE;DOT;LTC;BNB;USDT;UNI';

        const getAllItem = async () => {
            try {
                const options = {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CoinAPI-Key": myKey
                    }
                };

                const response = await fetch(`${baseUrl}/assets/${filterCoin}`, options);
                const responseJson = await response.json();

                if (responseJson.error) {
                    showResponseMessage(responseJson.error);
                } else {

                    //LOOPING EVERY FITEM

                    responseJson.slice(0, 15).forEach(element => {
                        console.log("ready!");
                        appendItem(element);
                    });

                }
            } catch (error) {
                showResponseMessage(error);
            }
        }

        const appendItem = async (item) => {
            const itemWilappended = await renderItem(item);
            $("#coin-container").append(itemWilappended);
        }

        const renderItem = async (item) => {
            const afterObjHitung = await findPerItem(item);
            return `
            <div class="col-xl-3 card-col col-sm-12">
                <div class="card">
                    <div class="divku-1">
                        <img src="./node_modules/cryptocurrency-icons/svg/color/${item.asset_id.toLowerCase()}.svg" class="img-crypto card-img-top"
                            alt="${item.asset_id}-image">
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">${item.name} <span class="singkatanku">${item.asset_id} </span><span class="${afterObjHitung.colorClass}"><i
                                    class="fa-solid fa-caret-${afterObjHitung.caret}"></i>
                                ${afterObjHitung.percentageDifferent}%</span></h5>
                        <p class="card-text">
                            <b>Price - </b>  ${formatter.format(harga)} <br>
                            <b>Volume(24h) -</b> ${formatter.format(item.volume_1day_usd)}
                        </p>
                        
                    </div>
                </div>
            </div>
            `;
        }

        const findPerItem = async (item) => {
            //GET EXACT YESTERDAY PRICE
            let yesterday;
            var date2 = new Date();
            date2.setDate(date2.getDate() - 1);
            yesterday = date2.toISOString();

            try {
                const options = {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CoinAPI-Key": myKey
                    }
                };

                const response = await fetch(`${baseUrl}/exchangerate/${item.asset_id}/USD?time=${yesterday}`, options);
                const responseJson = await response.json();

                if (responseJson.error) {
                    showResponseMessage(responseJson.error);
                } else {
                    //CALCULATE PERCENTAGE NOW
                    let caret;
                    let colorClass;

                    let percentageDifferent = ((parseInt(item.rate) - parseInt(responseJson.rate)) / ((parseInt(item.rate) + parseInt(responseJson.rate)) / 2)) * 100;

                    if (item.rate >= responseJson.item) {
                        colorClass = "hijauku";
                        caret = "up";
                    } else {
                        colorClass = "merahku";
                        caret = "down";
                    }

                    const objKu = { caret: caret, colorClass: colorClass, percentageDifferent: percentageDifferent };
                    return objKu;
                }
            } catch (error) {
                showResponseMessage(error);
            }
        }

        const showResponseMessage = (errormsg) => {
            alert(errormsg);
        }

        var formatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',

            // These options are needed to round to whole numbers if that's what you want.
            minimumFractionDigits: 2, // (this suffices for whole numbers, but will print 2500.10 as $2,500.1)
            //maximumFractionDigits: 0, // (causes 2500.99 to be printed as $2,501)
        });
    </script>
</body>

</html>